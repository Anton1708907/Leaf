<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <title>–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è —á–µ—Ä–µ–∑ Phantom</title>
</head>
<body>
  <h1>üîê –£–≤—ñ–π—Ç–∏ —á–µ—Ä–µ–∑ Phantom</h1>
  <button id="login">–£–≤—ñ–π—Ç–∏</button>
  <p id="status">–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–æ</p>

  <script>
    document.getElementById("login").onclick = async () => {
      const status = document.getElementById("status");

      if (!window.solana || !window.solana.isPhantom) {
        return alert("–í—Å—Ç–∞–Ω–æ–≤–∏ Phantom Wallet");
      }

      try {
        const resp = await window.solana.connect();
        const wallet = resp.publicKey.toString();
        status.textContent = "–ü—ñ–¥–∫–ª—é—á–µ–Ω–æ: " + wallet;

        // 1. –û—Ç—Ä–∏–º—É—î–º–æ nonce
        const nonceRes = await fetch("http://localhost:3000/auth/nonce", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ wallet }),
        });

        const { nonce } = await nonceRes.json();

        // 2. –ü—ñ–¥–ø–∏—Å—É—î–º–æ nonce
        const encoded = new TextEncoder().encode(nonce);
        const signed = await window.solana.signMessage(encoded, "utf8");

        // 3. –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏
        const res = await fetch("http://localhost:3000/auth/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            wallet,
            signature: Array.from(signed.signature), // Uint8Array ‚Üí Array
          }),
        });

        const data = await res.json();
        if (data.success && data.token) {
          localStorage.setItem("jwt", data.token);
          status.textContent = "‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–æ!";
          window.location.href = "./dashboard.html";
        } else {
          status.textContent = "‚ùå –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è –Ω–µ—É—Å–ø—ñ—à–Ω–∞";
        }
      } catch (err) {
        console.error(err);
        status.textContent = "–ü–æ–º–∏–ª–∫–∞: " + err.message;
      }
    };
  </script>
</body>
</html>
