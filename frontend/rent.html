<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <title>–û—Ä–µ–Ω–¥–∞ GPU</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: sans-serif; padding: 2em; background: #f2f2f2; }
    .gpu-card {
      background: white;
      padding: 1em;
      margin-bottom: 1em;
      border-radius: 5px;
      box-shadow: 0 0 3px rgba(0,0,0,0.1);
    }
    .gpu-card input {
      margin-top: 0.5em;
      display: block;
    }
    .gpu-card button {
      margin-top: 0.5em;
    }
  </style>
</head>
<body>
  <h1>üß† –û—Ä–µ–Ω–¥—É–≤–∞—Ç–∏ GPU</h1>
  <div id="gpuList">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>

  <script>
    const token = localStorage.getItem("jwt");
    const gpuList = document.getElementById("gpuList");

    if (!token) {
      alert("‚õî –°–ø–æ—á–∞—Ç–∫—É —É–≤—ñ–π–¥—ñ—Ç—å");
      window.location.href = "login.html";
    }

    async function fetchAvailableGPUs() {
      const res = await fetch("http://localhost:3000/gpus/available");
      const gpus = await res.json();
      gpuList.innerHTML = "";

      if (!gpus.length) {
        gpuList.innerHTML = "<p>–ü–æ–∫–∏ –Ω–µ–º–∞—î –¥–æ—Å—Ç—É–ø–Ω–∏—Ö GPU üò¢</p>";
        return;
      }

      gpus.forEach(gpu => {
        const card = document.createElement("div");
        card.className = "gpu-card";
        card.id = `gpu-${gpu.id}`;
        card.innerHTML = `
          <strong>${gpu.model}</strong> (${gpu.vram_gb}GB VRAM)<br>
          –õ–æ–∫–∞—Ü—ñ—è: ${gpu.location || "‚Äî"}<br>
          –¶—ñ–Ω–∞: ${gpu.price_per_hour} SOL/–≥–æ–¥<br>
          <input type="number" placeholder="–ì–æ–¥–∏–Ω –¥–ª—è –æ—Ä–µ–Ω–¥–∏" min="1" id="dur-${gpu.id}" />
          <button onclick="rentGPU('${gpu.id}', '${gpu.price_per_hour}')">–û—Ä–µ–Ω–¥—É–≤–∞—Ç–∏</button>
          <p id="status-${gpu.id}"></p>
        `;
        gpuList.appendChild(card);
      });
    }

    async function rentGPU(gpuId, pricePerHour) {
      const durationInput = document.getElementById(`dur-${gpuId}`);
      const statusMsg = document.getElementById(`status-${gpuId}`);
      const duration = parseInt(durationInput.value);

      if (!duration || duration < 1) {
        return alert("–í–≤–µ–¥—ñ—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—É –∫—ñ–ª—å–∫—ñ—Å—Ç—å –≥–æ–¥–∏–Ω");
      }

      try {
        const res = await fetch("http://localhost:3000/sessions/start", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + token
          },
          body: JSON.stringify({
            gpu_id: gpuId,
            duration_hours: duration,
            price_per_hour: parseFloat(pricePerHour)
          })
        });

        const result = await res.json();
        if (result.success) {
          const session = result.session;
          const sessionId = session.id;
          statusMsg.innerHTML = `‚úÖ –°–µ—Å—ñ—è –∞–∫—Ç–∏–≤–Ω–∞ (${duration} –≥–æ–¥)<br>`;

          const finishBtn = document.createElement("button");
          finishBtn.textContent = "‚èπ –ó–∞–≤–µ—Ä—à–∏—Ç–∏ –≤—Ä—É—á–Ω—É";
          finishBtn.onclick = () => endSession(sessionId, gpuId);
          statusMsg.appendChild(finishBtn);

          // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è –ø—ñ—Å–ª—è –∑–∞–∑–Ω–∞—á–µ–Ω–æ–≥–æ —á–∞—Å—É
          setTimeout(() => {
            endSession(sessionId, gpuId);
          }, duration * 3600 * 1000); // –≥–æ–¥–∏–Ω ‚Üí –º—Å
        } else {
          statusMsg.textContent = "‚ùå " + result.error;
        }
      } catch (err) {
        statusMsg.textContent = "‚ùå –°–∏—Å—Ç–µ–º–Ω–∞ –ø–æ–º–∏–ª–∫–∞";
        console.error(err);
      }
    }

    async function endSession(sessionId, gpuId) {
      const statusMsg = document.getElementById(`status-${gpuId}`);

      try {
        const res = await fetch("http://localhost:3000/sessions/end", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ session_id: sessionId })
        });

        const result = await res.json();
        if (res.ok) {
          statusMsg.innerHTML = `‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ. –í–∞—Ä—Ç—ñ—Å—Ç—å: ${result.total_cost} SOL<br>üéÅ –ù–∞–≥–æ—Ä–æ–¥–∞: ${result.reward_issued} SOL`;
        } else {
          statusMsg.textContent = "‚ùå –ü–æ–º–∏–ª–∫–∞: " + result.error;
        }
      } catch (err) {
        statusMsg.textContent = "‚ùå –°–∏—Å—Ç–µ–º–Ω–∞ –ø–æ–º–∏–ª–∫–∞";
        console.error(err);
      }
    }

    fetchAvailableGPUs();
  </script>
</body>
</html>
